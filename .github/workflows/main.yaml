name: CI
on:
  push: 
      branches: [ 'main' ]
  workflow_dispatch:
jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    strategy: 
      fail-fast: false
      matrix:
        include:
          - dockerfile: ./back/Dockerfile
            context: ./back
            image: andytakker/tth_back
          - dockerfile: ./front/Dockerfile
            context: ./front
            image: andytakker/tth_front
          - dockerfile: ./nginx/Dockerfile
            context: ./nginx
            image: andytakker/tth_nginx
    permissions:
        contents: read
        packages: write
    
    steps:
        - name: Checkout repository
          uses: actions/checkout@v2
          
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v2

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
        
        - name: Login to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Extract metadata (tags, labels) for Docker
          id: meta
          uses: docker/metadata-action@v4
          with:
            images: ${{ matrix.image }}
 
        - name: check
          run: ls . && pwd

        - name: Build and push Docker image stackoverfollowers
          uses: docker/build-push-action@v4
          with:
            file: ${{ matrix.dockerfile }}
            push: true
            context: ${{ matrix.context }}
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}

  update-server:
    needs: build-and-push-images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download docker images
        env: 
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          eval `ssh-agent -k` > /dev/null
          eval `ssh-agent -s` > /dev/null
          echo "start agent"
          echo "$SSH_PRIVATE_KEY" > secret_key
          chmod 600 secret_key
          ssh-add secret_key
          SSH_CMD="ssh -T -A -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST"
          $SSH_CM << EOF
            docker kill $(docker ps -q)
            docker container rm $(docker container ls -aq)
            docker image rm --force $(docker images -q)
            source .env
            docker run -d -p 5432:$POSTGRES_PORT --env-file .env --mount source=postgres_data,target=/var/lib/postgresql/data --restart on-failure:5 --name db --network=my-network --network-alias=db postgres:14
            docker run -d -p 6379:$REDIS_PORT --env-file .env --mount source=redis_data,target=/data --restart on-failure:5 --name redis --network=my-network --network-alias=redis redis redis-server --requirepass $REDIS_PASSWORD
            docker run -d -p 3001:$BACK_PORT --env-file .env --mount source=static_data,target=$STATIC_PATH --restart on-failure:5 --name back --network=my-network --network-alias=back andytakker/tth_back:main uvicorn main:app --host 0.0.0.0 --port $BACK_PORT
            docker run -d --env-file .env --mount source=static_data, target=$STATIC_PATH --restart on-failure:5 --name celery_worker --network=my-network --network-alias=celery_worker andytakker/tth_back:main celery -A celery_conf worker -Q preprocess_video -E -l INFO -f /logs/celery_worker.log --concurrency 4
            docker run -d -p 3000:$FRONT_PORT --env-file .env --restart on-failure:5 --name front --network=my-network --network-alias=front andytakker/tth_front:main
            docker run -d -p 80:80 -p 443:443 --env-file .env --restart on-failure:5 --name nginx --network=my-network --network-alias=nginx andytakker/tth_nginx:main
            docker exec back alembic upgrade head
          EOF